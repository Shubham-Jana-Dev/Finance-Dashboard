<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Finance Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons (for cool icons) -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray-blue background */
            color: #1f2937;
        }
        .card {
            background-color: white;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px); /* Subtle lift effect */
        }
        .header-section {
            background: linear-gradient(105deg, #4f46e5 0%, #10b981 100%); /* Indigo to Teal gradient */
            color: white;
            padding: 2rem 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px -5px rgba(79, 70, 229, 0.4);
        }
        input, select {
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            padding: 0.65rem 1rem;
            width: 100%;
            background-color: #f9fafb;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus {
            border-color: #4f46e5; /* Primary color focus */
            outline: 0;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        button {
            transition: background-color 0.2s, transform 0.1s;
        }
        button:active {
            transform: scale(0.98);
        }
        .transaction-list-item {
            border-left-width: 4px;
            padding: 0.75rem;
        }
        /* Ensure smooth scrolling and prevent horizontal overflow on mobile */
        html, body {
            overflow-x: hidden;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-10">

    <div class="max-w-7xl mx-auto">
        <!-- HEADER SECTION (Cool Gradient) -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">Sleek Finance Dashboard</h1>
            <p class="text-gray-500 mt-1">Your powerful, real-time personal ledger. Stay on top of your money.</p>
        </header>

        <!-- DASHBOARD / SUMMARY SECTION -->
        <div class="header-section grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
            <div class="text-center p-3 sm:p-4 rounded-xl bg-white bg-opacity-15 backdrop-blur-sm">
                <i class="ph-wallet text-2xl mb-1"></i>
                <p class="text-xs opacity-80 font-medium">Net Worth</p>
                <p id="totalBalanceDisplay" class="text-2xl font-extrabold mt-1">₹ 0.00</p>
            </div>
            <div class="text-center p-3 sm:p-4 rounded-xl bg-white bg-opacity-15 backdrop-blur-sm">
                <i class="ph-money text-2xl mb-1"></i>
                <p class="text-xs opacity-80 font-medium">Hard Cash</p>
                <p id="cashBalanceDisplay" class="text-2xl font-extrabold mt-1 text-teal-200">₹ 0.00</p>
            </div>
            <div class="text-center p-3 sm:p-4 rounded-xl bg-white bg-opacity-15 backdrop-blur-sm">
                <i class="ph-bank text-2xl mb-1"></i>
                <p class="text-xs opacity-80 font-medium">Bank Balance</p>
                <p id="bankBalanceDisplay" class="text-2xl font-extrabold mt-1 text-indigo-200">₹ 0.00</p>
            </div>
            <div class="text-center p-3 sm:p-4 rounded-xl bg-white bg-opacity-15 backdrop-blur-sm">
                <i class="ph-chart-line-down text-2xl mb-1"></i>
                <p class="text-xs opacity-80 font-medium">Total Expenses</p>
                <p id="totalExpenseDisplay" class="text-2xl font-extrabold mt-1 text-rose-200">₹ 0.00</p>
            </div>
        </div>

        <!-- MAIN LAYOUT: FORMS AND LEDGERS -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMN 1: FORMS -->
            <div class="lg:col-span-1 space-y-6">

                <!-- 1. MANUAL BALANCE UPDATE -->
                <div id="balanceUpdateCard" class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                        <i class="ph-gear-six text-indigo-500 mr-2"></i> Initial Setup
                    </h2>
                    <form id="balanceUpdateForm" class="space-y-4">
                        <div>
                            <label for="initialCash" class="block text-sm font-medium text-gray-700">Hard Cash</label>
                            <input type="number" id="initialCash" placeholder="Cash Amount" required>
                        </div>
                        <div>
                            <label for="initialBank" class="block text-sm font-medium text-gray-700">Bank Account Balance</label>
                            <input type="number" id="initialBank" placeholder="Bank Balance" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-xl hover:bg-indigo-700 font-semibold shadow-md shadow-indigo-200">Set Initial Balances</button>
                    </form>
                </div>

                <!-- 2. ADD INCOME -->
                <div id="incomeCard" class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                        <i class="ph-arrow-circle-down text-teal-500 mr-2"></i> Add Income
                    </h2>
                    <form id="incomeForm" class="space-y-4">
                        <div><input type="number" id="incomeAmount" placeholder="Amount (₹)" required></div>
                        <div><input type="date" id="incomeDate" value="" required></div>
                        <div><input type="text" id="incomeSource" placeholder="Source (e.g., Salary, Gift)" required></div>
                        <div><input type="text" id="incomeRemark" placeholder="Brief description" required></div>
                        <button type="submit" class="w-full bg-teal-600 text-white py-2.5 rounded-xl hover:bg-teal-700 font-semibold shadow-md shadow-teal-200">Record Income</button>
                    </form>
                </div>

                <!-- 3. ADD EXPENSE -->
                <div id="expenseCard" class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                        <i class="ph-arrow-circle-up text-rose-500 mr-2"></i> Add Expense
                    </h2>
                    <form id="expenseForm" class="space-y-4">
                        <div><input type="number" id="expenseAmount" placeholder="Amount (₹)" required></div>
                        <div><input type="date" id="expenseDate" value="" required></div>
                        <div><input type="text" id="expenseLocation" placeholder="Location/Vendor" required></div>
                        <div><input type="text" id="expenseRemark" placeholder="What was it for?" required></div>
                        <div>
                            <select id="expenseSourceType" required>
                                <option value="cash">Cash Payment</option>
                                <option value="bank">Bank/UPI Payment</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-rose-600 text-white py-2.5 rounded-xl hover:bg-rose-700 font-semibold shadow-md shadow-rose-200">Record Expense</button>
                    </form>
                </div>
            </div>

            <!-- COLUMN 2: DEBT TRACKER & HISTORY -->
            <div class="lg:col-span-2 space-y-6">

                 <!-- DEBT TRACKER -->
                <div id="debtTrackerCard" class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                         <i class="ph-handshake text-yellow-600 mr-2"></i> Debt & Receivable Manager
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="p-3 bg-rose-50 rounded-xl text-center border border-rose-200">
                            <p class="text-xs text-gray-600 font-medium">I Owe (Payable)</p>
                            <p id="totalBorrowedDisplay" class="text-2xl font-bold text-rose-600 mt-1">₹ 0.00</p>
                        </div>
                        <div class="p-3 bg-teal-50 rounded-xl text-center border border-teal-200">
                            <p class="text-xs text-gray-600 font-medium">I am Owed (Receivable)</p>
                            <p id="totalLentDisplay" class="text-2xl font-bold text-teal-600 mt-1">₹ 0.00</p>
                        </div>
                    </div>

                    <form id="debtForm" class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-5 p-4 bg-gray-50 rounded-lg">
                        <div class="col-span-full">
                            <select id="debtType" required>
                                <option value="lent">I Lent Money (Receivable)</option>
                                <option value="borrowed">I Borrowed Money (Payable)</option>
                            </select>
                        </div>
                        <div class="col-span-2"><input type="number" id="debtAmount" placeholder="Amount (₹)" required></div>
                        <div class="col-span-2"><input type="date" id="debtDate" value="" required></div>
                        <div class="col-span-full"><input type="text" id="debtName" placeholder="Person's Name" required></div>
                        <div class="col-span-full"><input type="text" id="debtRemark" placeholder="Reason for debt" required></div>
                        <button type="submit" class="col-span-full bg-yellow-600 text-white py-2.5 rounded-xl hover:bg-yellow-700 font-semibold shadow-md shadow-yellow-200">Add Debt Record</button>
                    </form>

                    <!-- DEBT LISTS -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                        <div>
                            <h3 class="text-md font-bold text-teal-600 border-b-2 border-teal-100 pb-1 mb-3 flex items-center"><i class="ph-arrow-down-right-bold mr-1"></i> Receivables</h3>
                            <div id="lentList" class="space-y-3">
                                <!-- Lent items will be listed here -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-bold text-rose-600 border-b-2 border-rose-100 pb-1 mb-3 flex items-center"><i class="ph-arrow-up-left-bold mr-1"></i> Payables</h3>
                            <div id="borrowedList" class="space-y-3">
                                <!-- Borrowed items will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INCOME AND EXPENSE HISTORY -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="incomeHistoryCard" class="card p-6">
                        <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700"><i class="ph-currency-inr text-teal-500 mr-2"></i> Income History</h2>
                        <div id="incomeList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                            <!-- Income history will be listed here -->
                        </div>
                    </div>
                    <div id="expenseHistoryCard" class="card p-6">
                        <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700"><i class="ph-bag-simple text-rose-500 mr-2"></i> Expense History</h2>
                        <div id="expenseList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                            <!-- Expense history will be listed here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Confirmation Modal (Custom for no alert()) -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white p-7 rounded-2xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-gray-800 flex items-center"><i class="ph-check-circle-fill text-blue-500 mr-2"></i> Repayment</h3>
            <p id="modalMessage" class="mb-5 text-gray-600"></p>
            <div id="modalContent" class="space-y-3">
                <!-- Dynamic content for repayment method -->
            </div>
            <div class="mt-7 flex justify-end space-x-3">
                <button id="modalCancel" class="px-5 py-2 text-gray-700 bg-gray-200 rounded-xl hover:bg-gray-300 font-medium">Cancel</button>
                <button id="modalConfirm" class="px-5 py-2 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-medium shadow-md shadow-indigo-200">Confirm Action</button>
            </div>
        </div>
    </div>

    <!-- Temporary Message Container (Snack Bar) -->
    <div id="snackbar-container" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
        <!-- Messages will be injected here -->
    </div>


    <script>
        const STORAGE_KEY = 'financeTrackerState_enhanced';
        let state = {
            bankBalance: 0,
            cashBalance: 0,
            incomes: [],
            expenses: [],
            lent: [],
            borrowed: []
        };

        // --- Utility Functions ---

        // Function to format currency using Indian Rupee sign
        const formatCurrency = (amount) => {
            const num = parseFloat(amount);
            if (isNaN(num)) return '₹ 0.00';
            // Use Intl.NumberFormat for proper Indian comma separation and decimal
            return `₹ ${num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        const loadState = () => {
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    state = JSON.parse(storedState);
                }
            } catch (e) {
                console.error("Local storage load error:", e);
            }
        };

        const saveState = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                renderApp();
            } catch (e) {
                console.error("Local storage save error:", e);
            }
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- Core Rendering Function ---

        const renderApp = () => {
            renderDashboard();
            renderLists();
        };

        const renderDashboard = () => {
            const totalBalance = state.cashBalance + state.bankBalance;
            document.getElementById('totalBalanceDisplay').textContent = formatCurrency(totalBalance);
            document.getElementById('cashBalanceDisplay').textContent = formatCurrency(state.cashBalance);
            document.getElementById('bankBalanceDisplay').textContent = formatCurrency(state.bankBalance);

            const totalExpense = state.expenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            document.getElementById('totalExpenseDisplay').textContent = formatCurrency(totalExpense);

            const totalLent = state.lent.filter(d => d.status === 'outstanding').reduce((sum, item) => sum + parseFloat(item.amount), 0);
            document.getElementById('totalLentDisplay').textContent = formatCurrency(totalLent);

            const totalBorrowed = state.borrowed.filter(d => d.status === 'outstanding').reduce((sum, item) => sum + parseFloat(item.amount), 0);
            document.getElementById('totalBorrowedDisplay').textContent = formatCurrency(totalBorrowed);

            // Set current balances in manual update form
            document.getElementById('initialCash').value = state.cashBalance.toFixed(2);
            document.getElementById('initialBank').value = state.bankBalance.toFixed(2);
        };

        const renderLists = () => {
            // Helper for list item visual
            const listClasses = "p-3 rounded-lg flex justify-between items-center transition duration-200 hover:shadow-md border";

            // 1. Expense List
            const expenseList = document.getElementById('expenseList');
            expenseList.innerHTML = '';
            state.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
                const icon = exp.sourceType === 'cash' ? 'ph-money' : 'ph-bank';
                expenseList.innerHTML += `
                    <div class="${listClasses} border-rose-200 bg-white shadow-sm">
                        <div class="flex items-center space-x-3">
                            <i class="${icon} text-rose-500 text-xl"></i>
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${exp.remark}</p>
                                <p class="text-xs text-gray-500">${exp.location} | ${exp.date}</p>
                            </div>
                        </div>
                        <span class="font-bold text-rose-600 text-sm">- ${formatCurrency(exp.amount)}</span>
                    </div>
                `;
            });
            if (expenseList.innerHTML === '') expenseList.innerHTML = '<p class="text-sm text-gray-500 p-3">No expenses recorded yet.</p>';


            // 2. Income List
            const incomeList = document.getElementById('incomeList');
            incomeList.innerHTML = '';
            state.incomes.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(inc => {
                incomeList.innerHTML += `
                    <div class="${listClasses} border-teal-200 bg-white shadow-sm">
                        <div class="flex items-center space-x-3">
                            <i class="ph-gift text-teal-500 text-xl"></i>
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${inc.remark}</p>
                                <p class="text-xs text-gray-500">${inc.source} | ${inc.date}</p>
                            </div>
                        </div>
                        <span class="font-bold text-teal-600 text-sm">+ ${formatCurrency(inc.amount)}</span>
                    </div>
                `;
            });
            if (incomeList.innerHTML === '') incomeList.innerHTML = '<p class="text-sm text-gray-500 p-3">No income recorded yet.</p>';

            // 3. Lent List (Outstanding - Receivables)
            const lentList = document.getElementById('lentList');
            lentList.innerHTML = '';
            state.lent.filter(d => d.status === 'outstanding').sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(d => {
                lentList.innerHTML += `
                    <div class="p-4 border-l-4 border-teal-500 bg-teal-50 rounded-lg flex justify-between items-center flex-wrap shadow-sm">
                        <div class="mb-1 sm:mb-0">
                            <p class="font-semibold text-gray-800">${d.name} <span class="text-teal-600 font-bold ml-1 text-base">${formatCurrency(d.amount)}</span></p>
                            <p class="text-xs text-gray-600">${d.remark} (${d.date})</p>
                        </div>
                        <button onclick="showRepaymentModal('${d.id}')" class="bg-teal-500 text-white text-xs px-3 py-1.5 rounded-full hover:bg-teal-600 font-medium transition mt-2 sm:mt-0 shadow-sm">Received</button>
                    </div>
                `;
            });
            if (lentList.innerHTML === '') lentList.innerHTML = '<p class="text-sm text-gray-500">All receivables cleared.</p>';


            // 4. Borrowed List (Outstanding - Payables)
            const borrowedList = document.getElementById('borrowedList');
            borrowedList.innerHTML = '';
            state.borrowed.filter(d => d.status === 'outstanding').sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(d => {
                borrowedList.innerHTML += `
                    <div class="p-4 border-l-4 border-rose-500 bg-rose-50 rounded-lg flex justify-between items-center flex-wrap shadow-sm">
                        <div class="mb-1 sm:mb-0">
                            <p class="font-semibold text-gray-800">${d.name} <span class="text-rose-600 font-bold ml-1 text-base">${formatCurrency(d.amount)}</span></p>
                            <p class="text-xs text-gray-600">${d.remark} (${d.date})</p>
                        </div>
                        <button onclick="markBorrowedRepaid('${d.id}')" class="bg-indigo-500 text-white text-xs px-3 py-1.5 rounded-full hover:bg-indigo-600 font-medium transition mt-2 sm:mt-0 shadow-sm">Repaid</button>
                    </div>
                `;
            });
            if (borrowedList.innerHTML === '') borrowedList.innerHTML = '<p class="text-sm text-gray-500">All payables cleared.</p>';
        };

        // --- Form Handling Functions ---

        document.getElementById('balanceUpdateForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const cash = parseFloat(document.getElementById('initialCash').value || 0);
            const bank = parseFloat(document.getElementById('initialBank').value || 0);

            if (isNaN(cash) || isNaN(bank) || cash < 0 || bank < 0) {
                showTemporaryMessage("Invalid balance amount entered.", "error");
                return;
            }

            state.cashBalance = cash;
            state.bankBalance = bank;
            saveState();
            showTemporaryMessage("Balances updated successfully!", "success");
        });

        document.getElementById('incomeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const source = document.getElementById('incomeSource').value;
            const remark = document.getElementById('incomeRemark').value;

            if (amount <= 0 || isNaN(amount)) {
                showTemporaryMessage("Invalid income amount entered.", "error");
                return;
            }

            const newIncome = { id: generateId(), amount, date, source, remark };
            state.incomes.push(newIncome);
            state.cashBalance += amount;
            saveState();
            showTemporaryMessage(`Income of ${formatCurrency(amount)} added to Cash.`, "success");
            e.target.reset();
            document.getElementById('incomeDate').valueAsDate = new Date();
        });

        document.getElementById('expenseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const location = document.getElementById('expenseLocation').value;
            const remark = document.getElementById('expenseRemark').value;
            const sourceType = document.getElementById('expenseSourceType').value;

            if (amount <= 0 || isNaN(amount)) {
                showTemporaryMessage("Invalid expense amount entered.", "error");
                return;
            }

            if (sourceType === 'cash' && amount > state.cashBalance) {
                showTemporaryMessage("Insufficient Cash Balance!", "error");
                return;
            }
            if (sourceType === 'bank' && amount > state.bankBalance) {
                showTemporaryMessage("Insufficient Bank Balance!", "error");
                return;
            }

            const newExpense = { id: generateId(), amount, date, location, remark, sourceType };
            state.expenses.push(newExpense);

            if (sourceType === 'cash') {
                state.cashBalance -= amount;
            } else if (sourceType === 'bank') {
                state.bankBalance -= amount;
            }

            saveState();
            showTemporaryMessage(`Expense of ${formatCurrency(amount)} recorded successfully!`, "success");
            e.target.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
        });

        document.getElementById('debtForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const debtType = document.getElementById('debtType').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value;
            const name = document.getElementById('debtName').value;
            const remark = document.getElementById('debtRemark').value;

            if (amount <= 0 || isNaN(amount)) {
                showTemporaryMessage("Invalid debt amount entered.", "error");
                return;
            }

            const newDebt = { id: generateId(), amount, date, name, remark, status: 'outstanding' };

            if (debtType === 'lent') {
                if (amount > state.cashBalance) {
                    showTemporaryMessage("Insufficient Cash to lend the amount!", "error");
                    return;
                }
                state.cashBalance -= amount;
                state.lent.push(newDebt);
                showTemporaryMessage(`₹ ${formatCurrency(amount)} lent to ${name}. Cash deducted.`, "success");
            } else { // borrowed
                state.cashBalance += amount;
                state.borrowed.push(newDebt);
                showTemporaryMessage(`₹ ${formatCurrency(amount)} borrowed from ${name}. Cash added.`, "success");
            }

            saveState();
            e.target.reset();
            document.getElementById('debtDate').valueAsDate = new Date();
        });

        // --- Debt Repayment Logic (Receivables - I am Owed) ---

        let currentRepaymentId = null;

        const showRepaymentModal = (debtId) => {
            currentRepaymentId = debtId;
            const debt = state.lent.find(d => d.id === debtId);
            if (!debt) return;

            document.getElementById('modalTitle').innerHTML = `<i class="ph-arrow-square-down-fill text-teal-500 mr-2"></i> Received Repayment from ${debt.name}`;
            document.getElementById('modalMessage').innerHTML = `Confirm receiving <span class="font-bold text-teal-600">${formatCurrency(debt.amount)}</span>. How was it paid?`;

            document.getElementById('modalContent').innerHTML = `
                <select id="repaymentMethod" class="w-full p-3 border rounded-lg bg-gray-50">
                    <option value="cash">Cash Received</option>
                    <option value="bank">UPI/Bank Transfer Received</option>
                </select>
            `;

            document.getElementById('modalConfirm').textContent = "Confirm & Add to Balance";
            document.getElementById('modalConfirm').onclick = handleLentRepayment;
            document.getElementById('modalCancel').onclick = () => document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
            document.querySelector('#modal > div').classList.remove('scale-95'); // Re-animate modal appearance
        };

        const handleLentRepayment = () => {
            const debt = state.lent.find(d => d.id === currentRepaymentId);
            const method = document.getElementById('repaymentMethod').value;
            const amount = parseFloat(debt.amount);

            if (method === 'cash') {
                state.cashBalance += amount;
            } else if (method === 'bank') {
                state.bankBalance += amount;
            }

            debt.status = 'repaid';
            saveState();
            document.getElementById('modal').classList.add('hidden');
            showTemporaryMessage(`Repayment of ${formatCurrency(amount)} added to ${method === 'cash' ? 'Cash' : 'Bank'} balance!`, "success");
        };

        // --- Debt Repayment Logic (Payables - I Owe) ---

        const markBorrowedRepaid = (debtId) => {
            const debt = state.borrowed.find(d => d.id === debtId);
            if (!debt) return;

            document.getElementById('modalTitle').innerHTML = `<i class="ph-arrow-square-up-fill text-rose-500 mr-2"></i> Repay to ${debt.name}`;
            document.getElementById('modalMessage').innerHTML = `Confirm paying back <span class="font-bold text-rose-600">${formatCurrency(debt.amount)}</span>. How will you pay? (This will also be recorded as an expense.)`;

            document.getElementById('modalContent').innerHTML = `
                <select id="repaymentExpenseMethod" class="w-full p-3 border rounded-lg bg-gray-50">
                    <option value="cash">Pay via Cash</option>
                    <option value="bank">Pay via Bank/UPI</option>
                </select>
            `;

            document.getElementById('modalConfirm').textContent = "Confirm Repayment & Deduct";
            document.getElementById('modalConfirm').onclick = () => handleBorrowedRepayment(debtId);
            document.getElementById('modalCancel').onclick = () => document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
            document.querySelector('#modal > div').classList.remove('scale-95');
        };

        const handleBorrowedRepayment = (debtId) => {
            const debtIndex = state.borrowed.findIndex(d => d.id === debtId);
            const debt = state.borrowed[debtIndex];
            const method = document.getElementById('repaymentExpenseMethod').value;
            const amount = parseFloat(debt.amount);

            // Check balance
            const currentBalance = method === 'cash' ? state.cashBalance : state.bankBalance;
            if (amount > currentBalance) {
                document.getElementById('modal').classList.add('hidden');
                showTemporaryMessage(`Insufficient ${method === 'cash' ? 'Cash' : 'Bank'} Balance to repay the debt!`, "error");
                return;
            }

            // Deduct balance
            if (method === 'cash') {
                state.cashBalance -= amount;
            } else {
                state.bankBalance -= amount;
            }

            // Record as expense
             const repaymentExpense = {
                id: generateId(),
                amount: amount,
                date: new Date().toISOString().split('T')[0],
                location: debt.name,
                remark: `Debt Repayment to ${debt.name}`,
                sourceType: method
            };
            state.expenses.push(repaymentExpense);

            // Mark debt as repaid
            state.borrowed[debtIndex].status = 'repaid';

            saveState();
            document.getElementById('modal').classList.add('hidden');
            showTemporaryMessage(`Debt repaid and ${formatCurrency(amount)} deducted from ${method === 'cash' ? 'Cash' : 'Bank'}.`, "success");
        }


        // --- Temporary Message Function (Cool Snack Bar) ---
        const showTemporaryMessage = (message, type) => {
            const container = document.getElementById('snackbar-container');
            const color = type === 'success' ? 'bg-teal-500 shadow-teal-300' : 'bg-rose-500 shadow-rose-300';
            const icon = type === 'success' ? '<i class="ph-check-circle-fill text-lg mr-2"></i>' : '<i class="ph-warning-circle-fill text-lg mr-2"></i>';

            const msgBox = document.createElement('div');
            msgBox.innerHTML = `${icon} ${message}`;
            msgBox.className = `p-3 rounded-xl text-white font-medium flex items-center shadow-lg transition-all transform duration-500 opacity-0 translate-y-4 ${color}`;

            container.appendChild(msgBox);

            // Animate in
            setTimeout(() => {
                msgBox.classList.remove('opacity-0', 'translate-y-4');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                msgBox.classList.add('opacity-0', 'translate-y-4');
                msgBox.addEventListener('transitionend', () => msgBox.remove());
            }, 3500);
        };


        // --- Initialization ---
        const init = () => {
            loadState();
            // Set current date on date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('debtDate').value = today;
            renderApp();
        };

        window.onload = init;
    </script>

</body>
</html>